# analysis_simple

Basic computer vision pipeline for detecting satellites, meteors, and other transient events in astronomical time-lapse images.

## Overview

This project provides tools to analyze sequences of astronomical images (time-lapse frames) to detect and catalog transient events such as:
- Satellite streaks
- Meteor trails
- Aircraft paths
- Other moving objects in the night sky

The analysis pipeline processes JPEG frames, builds a sky mask to exclude non-sky regions, and uses computer vision techniques (edge detection, Hough transforms) to identify linear streaks indicative of transient events.

## Features

- **Configurable Analysis Pipeline**: All detection parameters can be customized via YAML configuration
- **Smart Sky Masking**: Multi-frame analysis automatically excludes camera housing, overlay text, and dark regions
- **Persistent Edge Filtering**: Identifies and excludes static structures (trees, buildings, wires) that create false detections
- **Automatic Outlier Detection**: Filters out thumbnail images or frames with unusual dimensions
- **Streak Detection**: Uses Canny edge detection and Hough line transforms
- **Metrics Tracking**: Records brightness, contrast, and streak counts per frame
- **Event Cataloging**: Identifies and logs frames with significant transient activity
- **Visualization Tools**: Plot metrics over time and overlay detected streaks on images
- **Timelapse Generation**: Create MP4 videos from raw or annotated frame sequences
- **Validation Utilities**: Check data structure and image quality before analysis
- **Portable**: Automatically adapts to different camera locations and orientations

## Installation

### Prerequisites

- Python 3.7 or higher
- pip package manager

### Install Dependencies

```bash
pip install -r requirements.txt
```

This will install:
- `opencv-python` - Image processing, computer vision, and video encoding
- `numpy` - Numerical operations
- `matplotlib` - Plotting and visualization
- `PyYAML` - Configuration file parsing

## Usage

### Getting Data

If you don't have data yet, use the data_fetch tool to download images:

```bash
cd tools/data_fetch
python fetch.py 20251224
```

This automatically creates `../data/night_2025-12-24/frames/` and downloads all images.

### Running Analysis

#### Basic Analysis

Analyze a night's worth of frames:

```bash
python analysis_simple/analyze.py data/night_2025-12-24/
```

#### Run All Tools (Recommended)

Run validation, analysis, visualization, and overlay generation in one command:

```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --all-tools
```

This will:
1. **Validate** data structure and frames before analysis
2. **Analyze** all frames and detect transient events
3. **Visualize** metrics with time-series plots
4. **Overlay** detected streaks on event frames
5. **Generate** timelapse videos from raw and annotated frames

#### Individual Tool Options

Run specific tools:

```bash
# Validate before analysis
python analysis_simple/analyze.py data/night_2025-12-24/ --validate

# Generate plots after analysis
python analysis_simple/analyze.py data/night_2025-12-24/ --visualize

# Create annotated frames with detected streaks
python analysis_simple/analyze.py data/night_2025-12-24/ --overlay

# Generate timelapse videos
python analysis_simple/analyze.py data/night_2025-12-24/ --timelapse

# Combine multiple options
python analysis_simple/analyze.py data/night_2025-12-24/ --validate --visualize --timelapse
```

#### With Custom Configuration

```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --config custom_config.yaml --all-tools
```

#### Get Help

```bash
python analysis_simple/analyze.py --help
```

## Folder Structure

Your data should be organized as follows:

```
night_2025-12-24/
├── frames/
│   ├── frame_001.jpg
│   ├── frame_002.jpg
│   ├── frame_003.jpg
│   └── ...
├── config.yaml           (optional, night-specific configuration)
├── sky_mask.png          (generated each run)
├── persistent_edges.png  (generated each run)
├── combined_mask.png     (generated each run)
├── metrics.csv           (generated output)
├── events.json           (generated output)
├── plots/                (generated with --visualize)
│   ├── brightness_over_time.png
│   ├── contrast_over_time.png
│   └── streak_counts.png
├── annotated/            (generated with --overlay)
│   ├── frame_002.jpg     (streak count shown in top right)
│   └── ...
├── timelapse_raw.mp4     (generated with --timelapse)
└── timelapse_annotated.mp4  (generated with --timelapse + --overlay)
```

**Required:**
- `frames/` directory containing `.jpg` image files

**Optional:**
- `config.yaml` - Night-specific configuration (checked first before global config)

**Generated by analysis (regenerated each run):**
- `sky_mask.png` - Binary mask excluding non-sky regions (dark obstructions)
- `persistent_edges.png` - Mask excluding static structures (trees, buildings, wires)
- `combined_mask.png` - Final analysis mask combining sky_mask and persistent_edges
- `metrics.csv` - Per-frame statistics
- `events.json` - Detected transient events

**Generated with --visualize:**
- `plots/` - Directory containing time-series plots

**Generated with --overlay:**
- `annotated/` - Directory containing frames with detected streaks drawn

**Generated with --timelapse:**
- `timelapse_raw.mp4` - MP4 video timelapse of all raw frames
- `timelapse_annotated.mp4` - MP4 video timelapse of annotated frames (if --overlay also used)

## Output Files

### metrics.csv

CSV file with one row per frame containing:

| Column | Description |
|--------|-------------|
| `file` | Filename of the frame |
| `mean_brightness` | Average pixel brightness in sky region |
| `star_contrast` | Standard deviation of high-pass filtered image (star visibility metric) |
| `streak_count` | Number of linear streaks detected |

Example:
```csv
file,mean_brightness,star_contrast,streak_count
frame_001.jpg,45.23,12.8,0
frame_002.jpg,44.89,13.1,3
frame_003.jpg,46.12,12.5,1
```

### events.json

JSON file containing detected events (frames with significant streak activity):

```json
[
  {
    "file": "frame_002.jpg",
    "reason": "many_streaks",
    "streaks": [
      [120, 50, 180, 200],
      [250, 80, 280, 220]
    ]
  }
]
```

Each streak is represented as `[x1, y1, x2, y2]` - the start and end coordinates of the detected line.

### sky_mask.png

Grayscale image where:
- White pixels (255) = sky region to analyze
- Black pixels (0) = excluded regions (housing, overlays, dark areas)

Built using low-percentile analysis across 60 sampled frames to identify persistent dark obstructions.

### persistent_edges.png

Grayscale image identifying static structures:
- White pixels (255) = persistent edges to exclude (trees, buildings, wires, panel seams)
- Black pixels (0) = areas where edges don't repeat consistently

Built by detecting edges across 80 sampled frames. Edges that appear in ≥20% of samples are considered "persistent" and excluded from streak detection. This dramatically reduces false positives from treelines and static structures while preserving detection of real transient events.

**Why this works:** Trees, buildings, and fixed structures create edges in the same locations frame after frame. Real sky events (meteors, satellites, planes) do not repeat in the same pixels.

### combined_mask.png

Grayscale image showing the final analysis region:
- White pixels (255) = active analysis region where streaks are detected
- Black pixels (0) = excluded regions (combined exclusions from sky_mask and persistent_edges)

This mask is the result of combining `sky_mask.png` with `persistent_edges.png`:
```
combined_mask = sky_mask AND NOT persistent_edges
```

**Purpose:** This visualization shows you exactly what region of each frame is being analyzed for transient events. Review this file to verify that:
- Important sky regions are included (white)
- False positive sources are excluded (black)
- The balance between sky coverage and noise reduction is appropriate

**Using this for configuration tuning:**
- If too much sky is excluded (too much black), increase `persistent_edges.keep_fraction` in your config
- If false positives persist, decrease `persistent_edges.keep_fraction` or increase `persistent_edges.dilate_px`
- Adjust settings and re-run analysis to see updated mask - masks regenerate each run

## Configuration

The analysis pipeline can be customized using a YAML configuration file.

### Configuration File Search Priority

The script searches for configuration in this order:
1. **Explicit path** via `--config` flag (highest priority)
2. **Night directory** - `data/night_2025-12-24/config.yaml` (night-specific settings)
3. **Script directory** - `analysis_simple/config.yaml` (global defaults)

This allows you to have global defaults while overriding settings for specific nights.

### Configuration Parameters

```yaml
masking:
  sample_count: 60              # Number of frames to sample for mask building
  low_percentile: 20            # Percentile for identifying dark obstructions
  obstruction_threshold: 35     # Pixel brightness threshold for obstructions
  dilate_px: 8                  # Dilation pixels for safety margin
  overlay_region:               # Region to mask out (e.g., camera overlay text)
    top: 0
    bottom: 140
    left: 0
    right: 450
  resize_width: 0               # 0 = no resize (keep full resolution)

persistent_edges:
  sample_count: 80              # Number of frames to sample for edge detection
  canny_low: 40                 # Lower threshold for Canny edge detection
  canny_high: 120               # Upper threshold for Canny edge detection
  hp_sigma: 2.0                 # High-pass filter sigma (reduces clouds/glow)
  keep_fraction: 0.20           # Edge must appear in >=20% of samples
  dilate_px: 6                  # Dilation for tree sway tolerance

analysis:
  gaussian_sigma: 5             # Sigma for Gaussian blur in star contrast calculation

streak_detection:
  canny_low: 40                 # Lower threshold for Canny edge detection
  canny_high: 120               # Upper threshold for Canny edge detection
  hough_threshold: 60           # Accumulator threshold for Hough line detection
  min_line_length: 40           # Minimum line length in pixels
  max_line_gap: 10              # Maximum gap between line segments to connect

events:
  min_streaks: 2                # Minimum streaks to flag as an event

timelapse:
  fps: 30                       # Frames per second for video output
  quality: 8                    # Video quality 0-10 (lower = higher quality)
```

### Creating Custom Configuration

**Global configuration:**
```bash
cd analysis_simple/
# Edit config.yaml for global defaults
```

**Night-specific configuration:**
```bash
cp analysis_simple/config.yaml data/night_2025-12-24/config.yaml
# Edit data/night_2025-12-24/config.yaml for this night only
```

**Explicit configuration:**
```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --config path/to/custom_config.yaml
```

### Key Configuration Tips

**Reducing false positives from trees:**
- Lower `persistent_edges.keep_fraction` (try 0.15-0.25)
- Increase `persistent_edges.dilate_px` (6-10 for tree sway)
- Increase `streak_detection.min_line_length` (80-150)

**More sensitive detection:**
- Lower `streak_detection.hough_threshold`
- Lower `streak_detection.min_line_length`

**Masks regenerate on every run** using current configuration, so you can experiment freely.

## How Persistent Edge Masking Works

One of the key challenges in detecting transient sky events is distinguishing real events (satellites, meteors, aircraft) from static features in the environment like trees, buildings, and wires.

### The Problem

Traditional edge detection treats every edge equally, so:
- Treelines create hundreds of edge segments
- Building rooflines generate long lines
- Guy-wires and power lines appear as streaks
- These false positives overwhelm real sky events

### The Solution: Persistent Edge Detection

The system now uses a two-stage masking approach:

**Stage 1: Sky Mask**
- Samples 60 frames across the night
- Uses low-percentile analysis to identify dark obstructions
- Excludes: camera housing, overlay text, consistently dark regions

**Stage 2: Persistent Edge Mask**
- Samples 80 frames across the night
- Runs edge detection on each frame (within sky mask only)
- Accumulates edges: counts how many times each pixel is detected as an edge
- Creates "persistent edge" mask: pixels that are edges in ≥20% of frames
- Dilates slightly to account for tree sway and camera shake

**Final Combined Mask:**
```
effective_analysis_region = sky_mask AND NOT persistent_edges
```

### Why This Works

**Static structures** create edges in the same locations frame after frame:
- Trees: same branches appear in same pixels
- Buildings: roofline edges persist
- Wires: consistent linear features

**Real sky events** never repeat in the same pixels:
- Satellites move across different parts of sky
- Meteors appear in random locations
- Aircraft paths vary

### Benefits

✅ **Portable**: Automatically adapts when you relocate camera  
✅ **No manual annotation**: No need to draw exclusion regions  
✅ **Reduces false positives**: Typically 80-95% reduction in false detections  
✅ **Preserves real events**: Stars remain as points, sky events don't repeat spatially  
✅ **Self-updating**: Regenerates each run based on current frames

### Inspecting the Masks

After running analysis, you can open the generated mask files to verify:
- `sky_mask.png` - Should show the sky region in white
- `persistent_edges.png` - Should highlight treelines, buildings, fixed structures in white
- `combined_mask.png` - Shows the final analysis region (white = analyzed, black = excluded)

**Review `combined_mask.png` to understand what's being analyzed:**
- This is the actual mask used for streak detection
- White regions are where transient events will be detected
- Black regions are completely excluded from analysis

If `persistent_edges.png` shows too much sky highlighted, adjust `persistent_edges.keep_fraction` to a higher value (0.25-0.30).

## Visualization

The visualization and overlay tools are now integrated into `analyze.py` via command-line flags. However, they can still be run independently if needed.

### Plot Metrics Over Time

Visualize brightness, contrast, and streak counts:

**Integrated method (recommended):**
```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --visualize
```

**Standalone method:**
```bash
python analysis_simple/tools/visualize.py data/night_2025-12-24/
```

Generates plots in `data/night_2025-12-24/plots/`:
- `brightness_over_time.png`
- `contrast_over_time.png`
- `streak_counts.png`

Optional flags:
- `--show` - Display plots interactively
- `--output <dir>` - Specify custom output directory

### Overlay Detected Streaks

Draw detected streaks on the original images:

**Integrated method (recommended):**
```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --overlay
```

**Standalone method:**
```bash
python analysis_simple/tools/overlay_streaks.py data/night_2025-12-24/
```

Creates annotated images in `data/night_2025-12-24/annotated/` with detected streaks drawn in red.

Optional flags:
- `--output <dir>` - Specify custom output directory

### Generate Timelapse Videos

Create MP4 timelapse videos from frame sequences:

**Integrated method (recommended):**
```bash
# Generate both raw and annotated timelapses (if --overlay also used)
python analysis_simple/analyze.py data/night_2025-12-24/ --timelapse --overlay

# Or just raw frames
python analysis_simple/analyze.py data/night_2025-12-24/ --timelapse
```

**Standalone method:**
```bash
# Timelapse from raw frames
python analysis_simple/tools/timelapse.py data/night_2025-12-24/frames/

# Timelapse from annotated frames
python analysis_simple/tools/timelapse.py data/night_2025-12-24/annotated/ --output annotated.mp4

# Custom settings
python analysis_simple/tools/timelapse.py data/night_2025-12-24/frames/ \
    --output night.mp4 --fps 25 --quality 5
```

Generates:
- `timelapse_raw.mp4` - Video of all raw frames (integrated mode)
- `timelapse_annotated.mp4` - Video of annotated frames (if --overlay used)

Optional flags (standalone):
- `--output <path>` - Output MP4 file path
- `--fps <int>` - Frames per second (default: 30)
- `--quality <0-10>` - Video quality, lower=higher (default: 8)
- `--pattern <glob>` - Frame file pattern (default: *.jpg)
- `--quiet` - Suppress progress messages

## Validation

Before running analysis, validate your data structure:

**Integrated method (recommended):**
```bash
python analysis_simple/analyze.py data/night_2025-12-24/ --validate
```

**Standalone method:**
```bash
python analysis_simple/tools/validate_data.py data/night_2025-12-24/
```

This checks:
- Directory structure is correct
- Frames directory exists and contains images
- Image format and dimensions are consistent
- Configuration file validity
- Warns about potential issues

## Example Data

See `../data/night_2025-12-24/` for a sample data structure with example outputs.

## Troubleshooting

### Too many false positives (treelines, structures)
- The persistent edge mask should handle this automatically
- If still seeing false positives, try:
  - Lower `persistent_edges.keep_fraction` (0.15-0.20)
  - Increase `persistent_edges.dilate_px` (8-12)
  - Increase `streak_detection.min_line_length` (80-150)
- Open `persistent_edges.png` to verify it's capturing the problem areas

### Too few detections / missing real events
- Increase `persistent_edges.keep_fraction` (0.25-0.30) to be less aggressive
- Lower `streak_detection.hough_threshold` for more sensitive detection
- Lower `streak_detection.min_line_length` to catch shorter streaks
- Check if `persistent_edges.png` is masking too much sky

### Frames with different dimensions / thumbnails
- The script automatically detects and filters outlier dimensions
- Check console output for "Filtered out X frame(s) with different dimensions"
- These are typically thumbnail files that can be safely ignored

### "No frames found"
- Ensure your images are in `.jpg` format (not `.jpeg`, `.png`, etc.)
- Check that images are in the `frames/` subdirectory
- Run validation: `python analysis_simple/analyze.py <night_dir> --validate`

### Config file priority questions
- The script checks in this order:
  1. `--config` explicit path (highest priority)
  2. `night_dir/config.yaml` (night-specific)
  3. `analysis_simple/config.yaml` (global defaults)
- Place night-specific configs in the data directory for automatic loading

### Masks not updating after config changes
- Masks are now regenerated on every run automatically
- Old mask files are deleted at the start of each analysis
- No need to manually delete mask files anymore

### "IndexError: boolean index did not match"
- This means some frames have different dimensions than others
- The script now automatically skips frames with mismatched dimensions
- Check warnings in the output for which frames were skipped
- Run validation to identify problematic frames: `--validate`

### Memory issues with large datasets
- Consider reducing `sample_count` values in configuration
- Process nights individually rather than batch processing

### Video generation issues
- Timelapse generation uses OpenCV's VideoWriter with H.264 codec (avc1)
- If videos won't play, your system may need codec support
- All dependencies are already included with opencv-python
- Monitor progress output to identify problematic frames

### Tool scripts not running
- Ensure you're running from the project root directory
- Check that tool scripts exist in `analysis_simple/tools/`
- Run tools individually to see detailed error messages

## Contributing

Contributions are welcome! This is an experimental project for exploring ML techniques in astronomical image analysis.

## License

See repository for license information.
